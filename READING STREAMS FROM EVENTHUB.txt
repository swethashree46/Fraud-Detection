READING STREAMS FROM EVENTHUB

%scala

import org.apache.spark.eventhubs._
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._

// Event Hub connection string for Transactions
val txnConnectionString = "<AZURE_EVENT_HUB_CONNECTION_STRING>"

// Configure Event Hub
val txnEventHubConf = EventHubsConf(txnConnectionString)
  .setStartingPosition(EventPosition.fromEndOfStream)

// Read stream
val rawTxnDF = spark.readStream
  .format("eventhubs")
  .options(txnEventHubConf.toMap)
  .load()

// Define schema for transactions
val txnSchema = new StructType()
  .add("transaction_id", StringType)
  .add("customer_id", StringType)
  .add("merchant_id", StringType)
  .add("timestamp", StringType)
  .add("amount", DoubleType)
  .add("transaction_type", StringType)
  .add("transaction_city", StringType)
  .add("device_id", StringType)
  .add("is_fraud", IntegerType)

// Parse JSON
val transactionsDF = rawTxnDF
  .select(from_json(col("body").cast("string"), txnSchema).alias("data"))
  .select("data.*")


%scala

val custConnectionString = "<AZURE_EVENT_HUB_CONNECTION_STRING>"
val custEventHubConf = EventHubsConf(custConnectionString)
  .setStartingPosition(EventPosition.fromEndOfStream)

val rawCustDF = spark.readStream
  .format("eventhubs")
  .options(custEventHubConf.toMap)
  .load()

val customerSchema = new StructType()
  .add("customer_id", StringType)
  .add("customer_name", StringType)
  .add("city", StringType)
  .add("device_id", StringType)

val customersDF = rawCustDF
  .select(from_json(col("body").cast("string"), customerSchema).alias("data"))
 



%scala

val merchConnectionString = "<AZURE_EVENT_HUB_CONNECTION_STRING>"
val merchEventHubConf = EventHubsConf(merchConnectionString)
  .setStartingPosition(EventPosition.fromEndOfStream)

val rawMerchDF = spark.readStream
  .format("eventhubs")
  .options(merchEventHubConf.toMap)
  .load()

val merchantSchema = new StructType()
  .add("merchant_id", StringType)
  .add("merchant_name", StringType)
  .add("merchant_category", StringType)
  .add("city", StringType)

val merchantsDF = rawMerchDF
  .select(from_json(col("body").cast("string"), merchantSchema).alias("data"))
  .select("data.*")
